(()=>{"use strict";var e="";const t=document.querySelector("#card-template")?.content;function r(e,r,o,n){if(!t)return console.error("Шаблон карточки не найден"),null;const a=t.cloneNode(!0).querySelector(".card");if(a.dataset.cardId=e._id,!a)return console.error("Элемент карточки не найден в шаблоне"),null;const c=a.querySelector(".card__image"),i=a.querySelector(".card__title"),s=a.querySelector(".card__delete-button"),u=a.querySelector(".card__like-button"),l=a.querySelector(".card__like-container .card__like-count");return c&&i&&s&&u&&l?(c.src=e.link||"",c.alt=e.name||"",i.textContent=e.name||"",l.textContent=e.likes?e.likes.length:0,e.likes&&e.currentUserId&&e.likes.some((t=>t._id===e.currentUserId))&&u.classList.add("card__like-button_is-active"),u.addEventListener("click",(()=>{const t=u.classList.contains("card__like-button_is-active");o(e._id,t)})),e.owner._id!==e.currentUserId?s.remove():s.addEventListener("click",(()=>n(e._id))),c.addEventListener("click",(()=>r(e.link,e.name))),a):(console.error("Не найдены основные элементы карточки"),null)}function o(e){e&&!e.classList.contains("popup_is-opened")&&(e.classList.add("popup_is-opened"),document.addEventListener("keydown",a))}function n(e){e&&e.classList.contains("popup_is-opened")&&(e.classList.add("popup_fade-out"),requestAnimationFrame((()=>{setTimeout((()=>{e.classList.remove("popup_is-opened","popup_fade-out"),document.removeEventListener("keydown",a)}),300)})))}function a(e){const t=document.querySelector(".popup_is-opened");"Escape"===e.key&&t&&n(t)}function c(e){e.target.classList.contains("popup")&&n(e.target)}const i=(e,t,r)=>{const o=e.querySelector(`#${t.name}-error`);o&&(t.classList.remove(r.inputErrorClass),o.classList.remove(r.errorClass),o.textContent="")},s=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.disabled=!0,t.classList.add(r.inactiveButtonClass)):(t.disabled=!1,t.classList.remove(r.inactiveButtonClass))},u=e=>{const t=Array.from(e.querySelectorAll(".popup__input")),r=e.querySelector(".popup__button");t.forEach((t=>{i(e,t,{inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"})})),r.classList.add("popup__button_disabled"),r.disabled=!0},l=e+"images/logo.svg",p=e+"images/avatar.jpg",d="https://mesto.nomoreparties.co/v1/wff-cohort-36",_="1edbed4a-9f7a-4d96-b1b9-f5fbaa1e4e60";function m(e){return e.ok?e.json():Promise.reject(new Error(`Ошибка: ${e.status}`))}function y(e){return fetch(`${d}/cards/${e}/likes`,{method:"PUT",headers:{Authorization:_,"Content-Type":"application/json"}}).then(m)}function f(e){return fetch(`${d}/cards/${e}/likes`,{method:"DELETE",headers:{Authorization:_,"Content-Type":"application/json"}}).then(m)}document.querySelector(".header__logo").src=l,document.querySelector(".profile__image").style.backgroundImage=`url(${p})`;const v=".popup__button",h=document.querySelector(".places__list"),S={addCard:document.querySelector(".popup_type_new-card"),editProfile:document.querySelector(".popup_type_edit"),image:document.querySelector(".popup_type_image"),avatar:document.querySelector(".popup_type_avatar")},q=document.querySelector(".profile__edit-button"),g=document.querySelector(".profile__add-button"),C=document.querySelector(".profile__image"),b=document.querySelector(".profile__image");if(!b.querySelector(".profile__edit-icon")){const e=document.createElement("span");e.classList.add("profile__edit-icon"),b.append(e)}b.style.backgroundImage=`url(${p})`;const E=document.querySelector(".profile__title"),k=document.querySelector(".profile__description");let L;function $(e,t,r){e.textContent=t?"Сохранение...":r}function A(e,t){(t?f:y)(e).then((t=>{const r=document.querySelector(`[data-card-id="${e}"]`),o=r.querySelector(".card__like-button"),n=r.querySelector(".card__like-count");o.classList.toggle("card__like-button_is-active"),n.textContent=t.likes.length})).catch((e=>{console.error("Ошибка при обработке лайка:",e)}))}function T(e){(function(e){return fetch(`${d}/cards/${e}`,{method:"DELETE",headers:{Authorization:_,"Content-Type":"application/json"}}).then(m)})(e).then((()=>{const t=document.querySelector(`[data-card-id="${e}"]`);t&&t.remove()})).catch((e=>{console.error("Ошибка при удалении карточки:",e)}))}function x(e,t){const r=S.image.querySelector(".popup__image"),n=S.image.querySelector(".popup__caption");r.src=e,r.alt=t,n.textContent=t,o(S.image)}q?.addEventListener("click",(()=>{const e=S.editProfile.querySelector(".popup__form"),t=e.querySelector(".popup__input_type_name"),r=e.querySelector(".popup__input_type_description");t.value=E.textContent.trim(),r.value=k.textContent.trim(),u(e),o(S.editProfile)})),g?.addEventListener("click",(()=>{const e=S.addCard.querySelector(".popup__form");e.reset(),u(e),o(S.addCard)})),C?.addEventListener("click",(()=>{const e=S.avatar.querySelector(".popup__form");e.reset(),u(e),o(S.avatar)})),document.querySelectorAll(".popup").forEach((e=>{e.addEventListener("click",c)})),document.querySelectorAll(".popup__close").forEach((e=>{e.addEventListener("click",(e=>{n(e.target.closest(".popup"))}))})),S.editProfile.querySelector(".popup__form").addEventListener("submit",(function(e){e.preventDefault();const t=e.target.querySelector(v),r=t.textContent;$(t,!0,r);const o=e.target,a=o.querySelector(".popup__input_type_name"),c=o.querySelector(".popup__input_type_description");var i,s;(i=a.value,s=c.value,fetch(`${d}/users/me`,{method:"PATCH",headers:{Authorization:_,"Content-Type":"application/json"},body:JSON.stringify({name:i,about:s})}).then(m)).then((e=>{E.textContent=e.name,k.textContent=e.about,n(S.editProfile)})).catch((e=>{console.error("Ошибка при обновлении профиля:",e)})).finally((()=>$(t,!1,r)))})),S.addCard.querySelector(".popup__form").addEventListener("submit",(function(e){e.preventDefault();const t=e.target.querySelector(v),o=t.textContent;$(t,!0,o);const a=e.target,c=a.querySelector(".popup__input_type_card-name"),i=a.querySelector(".popup__input_type_url");var s,l;(s=c.value,l=i.value,fetch(`${d}/cards`,{method:"POST",headers:{Authorization:_,"Content-Type":"application/json"},body:JSON.stringify({name:s,link:l})}).then(m)).then((e=>{const t=r({...e,currentUserId:L},x,A,T);var o;h.prepend(t),(o=a).reset(),u(o),n(S.addCard)})).catch((e=>{console.error("Ошибка при добавлении карточки:",e)})).finally((()=>$(t,!1,o)))})),S.avatar.querySelector(".popup__form").addEventListener("submit",(function(e){e.preventDefault();const t=e.target.querySelector(v),r=t.textContent;$(t,!0,r);var o;(o=e.target.querySelector(".popup__input_type_avatar-url").value,fetch(`${d}/users/me/avatar`,{method:"PATCH",headers:{Authorization:_,"Content-Type":"application/json"},body:JSON.stringify({avatar:o})}).then(m)).then((e=>{document.querySelector(".profile__image").style.backgroundImage=`url(${e.avatar})`,n(S.avatar)})).catch((e=>{console.error("Ошибка при обновлении аватара:",e)})).finally((()=>$(t,!1,r)))})),(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{t.addEventListener("submit",(e=>{e.preventDefault()})),((e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);s(r,o,t),r.forEach((n=>{n.addEventListener("input",(()=>{((e,t,r)=>{if(t.setCustomValidity(""),t.validity.valueMissing){const e=t.dataset.errorRequired||"Поле обязательное";t.setCustomValidity(e)}else if(t.validity.typeMismatch){const e=t.dataset.errorUrl||"Поле содержит именно URL в корректном формате";t.setCustomValidity(e)}else t.validity.patternMismatch&&t.dataset.errorMessage&&t.setCustomValidity(t.dataset.errorMessage);t.checkValidity()?i(e,t,r):((e,t,r,o)=>{const n=e.querySelector(`#${t.name}-error`);n&&(t.classList.add(o.inputErrorClass),n.textContent=r,n.classList.add(o.errorClass))})(e,t,t.validationMessage,r)})(e,n,t),s(r,o,t)}))}))})(t,e)}))})({formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_visible"}),Promise.all([fetch(`${d}/users/me`,{method:"GET",headers:{Authorization:_,"Content-Type":"application/json"}}).then(m),fetch(`${d}/cards`,{method:"GET",headers:{Authorization:_,"Content-Type":"application/json"}}).then(m)]).then((e=>{let[t,o]=e;L=t._id,E.textContent=t.name,k.textContent=t.about,document.querySelector(".profile__image").style.backgroundImage=`url(${t.avatar})`,function(e){e.forEach((e=>{const t=r({...e,currentUserId:L},x,A,T);h.append(t)}))}(o)})).catch((e=>{console.error("Ошибка при загрузке данных:",e)}))})();